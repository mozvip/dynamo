<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html" xmlns:p="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:f="http://java.sun.com/jsf/core" xmlns:c="http://java.sun.com/jsp/jstl/core">

<ui:composition template="/template.xhtml">

	<ui:define name="title">
		Music Files Editor
    </ui:define>

	<ui:define name="content">

		<h:form>
			<h:inputText value="#{musicFiles.artistsSearchFilter}" id="artistName" styleClass="form-control artist" p:placeholder="Artist" />
			<h:commandLink styleClass="suggestionButton" action="#{musicFiles.refresh}" tabindex="-1">
				<f:ajax execute="@form" render=":filesForm" />
			</h:commandLink>
			<h:inputText value="#{musicFiles.albumSearchFilter}" id="albumName" styleClass="form-control album" p:placeholder="Album">
				<f:ajax execute="@form" render=":filesForm" listener="#{musicFiles.refresh}" />
			</h:inputText>
		</h:form>
		
		<div id="manualArtistSearch" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h3>Manual Artist Search</h3>
					</div>
					<div class="modal-body">
						<h:form>
							<div class="input-group">
								<h:inputText value="#{musicFiles.newArtist}" styleClass="form-control artist" />
								<span class="input-group-btn">
									<h:commandLink styleClass="btn btn-primary" action="#{musicFiles.changeArtist}">
										<f:ajax execute="@form" render="@all" onevent="closeArtistDialogOnSuccess"></f:ajax>
										<i class="fa fa-apply" />&nbsp;Set Artist
									</h:commandLink>
								</span>
							</div>
						</h:form>
					</div>
				</div>
			</div>
		</div>

		<h:form id="filesForm">
			<ul class="pager">
				<li class="#{musicFiles.musicFilesPager.currentPage == 0 ? 'previous disabled' : 'previous'}">
					<h:commandLink action="#{musicFiles.musicFilesPager.goToPage( musicFiles.musicFilesPager.currentPage - 1 )}">
						Previous<f:ajax render="@form :messages"></f:ajax>
					</h:commandLink>
				</li>
				<li class="#{musicFiles.musicFilesPager.currentPage lt musicFiles.musicFilesPager.lastPage ? 'next' : ' next disabled'}">
					<h:commandLink action="#{musicFiles.musicFilesPager.goToPage( musicFiles.musicFilesPager.currentPage + 1 )}">
						Next<f:ajax render="@form :messages"></f:ajax>
					</h:commandLink>
				</li>
			</ul>
			<h:dataTable id="filesTable" var="musicFile" value="#{musicFiles.musicFilesPager.items}" styleClass="table table-condensed table-striped">
				<f:facet name="header">
					<div class="btn-group">
						<h:commandLink styleClass="btn btn-default btn-small" action="#{musicFiles.selectAll}">
							<i class="fa fa-check-square-o" />
							<f:ajax render="filesTable" />
						</h:commandLink>
						<h:commandLink styleClass="btn btn-default btn-small" action="#{musicFiles.unSelectAll}">
							<i class="fa fa-square-o" />
							<f:ajax render="filesTable" />
						</h:commandLink>
						<div class="btn-group">
						  <a class="btn btn-default btn-small dropdown-toggle" data-toggle="dropdown" href="#">
						    Action
						    <span class="caret"></span>
						  </a>
						  <ul class="dropdown-menu">
							<li>
								<h:outputLink p:data-toggle="modal" p:data-target="#manualArtistSearch">Set Artist</h:outputLink>
							</li>
							<li>
								<h:outputLink p:data-toggle="modal" p:data-target="#manualAlbumSearch">Set Album</h:outputLink>
							</li>
							<li><h:commandLink action="#{musicFiles.deleteFiles}" onclick="return confirm('Are you sure you want to delete these files ?');">&nbsp;Delete Files<f:ajax execute="@form" render="@form" /></h:commandLink></li>
							<li><h:commandLink action="#{musicFiles.identifyFiles}">&nbsp;Identify Files<f:ajax execute="@form" render="@form" /></h:commandLink></li>
						  </ul>
						</div>
						<div class="btn-group">
							<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">Set Compilation Artist<span class="caret"></span>
							</button>
							<ul class="dropdown-menu" role="menu">
								<li>
									<h:commandLink action="#{musicFiles.setAlbumArtist('Various Artists')}">
										Various Artists
									</h:commandLink>
								</li>
								<li>
									<h:commandLink action="#{musicFiles.setAlbumArtist('Original Soundtrack')}">
										Original Soundtrack
									</h:commandLink>
								</li>
								<li>
									<h:commandLink action="#{musicFiles.setAlbumArtist('Mash-Up')}">
										Mash-Up
									</h:commandLink>
								</li>
								<li>
									<h:commandLink action="#{musicFiles.setAlbumArtist('Top Singles')}">
										Top Singles
									</h:commandLink>
								</li>
								<li>
									<h:commandLink action="#{musicFiles.setAlbumArtist('Video Game Soundtrack')}">
										Video Game Soundtrack
									</h:commandLink>
								</li>
							</ul>
						</div>
					</div>
				</f:facet>
				<h:column>
					<h:selectBooleanCheckbox id="checkbox" value="#{musicFiles.selection[musicFile]}" />
				</h:column>
				<h:column>
					#{musicFile.path}
				</h:column>
				<h:column>
					<f:facet name="header">
						Track
					</f:facet>
					#{musicFile.track}
				</h:column>
				<h:column>
					<f:facet name="header">
						Song Artist
					</f:facet>
					#{musicFile.songArtist}
				</h:column>
				<h:column>
					<f:facet name="header">
						Song Title
					</f:facet>
					#{musicFile.songTitle}
				</h:column>
			</h:dataTable>
		</h:form>

	</ui:define>
	<ui:define name="custom_js">
		<script type="application/javascript">
		
			function closeArtistDialogOnSuccess(e) {
				if (e.status == 'success') {
					$('#manualArtistSearch').modal('hide');
				}
			}		

			var artists = new Bloodhound({
				  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
				  queryTokenizer: Bloodhound.tokenizers.whitespace,
				  remote: '/services/suggest-music-artist/?prefix=%QUERY'
				});

			artists.initialize();

			$('.artist')
					.typeahead(
					{
						items: 20,
						highlight: true,
						source : artists.ttAdapter(),
					});
			
			$('.artist').change( function() {
				$(this).closest('form').find('.suggestionButton').click();
				
			});		
		</script>
	</ui:define>

</ui:composition>

</html>